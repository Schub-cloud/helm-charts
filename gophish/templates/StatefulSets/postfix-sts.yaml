{{- if .Values.postfix.enabled }}
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postfix-statefulset
  namespace: {{ .Values.nameSpace }}
spec:
  serviceName: postfix
  replicas: 1
  selector:
    matchLabels:
      app: postfix
      node-type: main
  podManagementPolicy: Parallel
  template:
    metadata:
      labels:
        app: postfix
        node-type: main
      name: postfix
    spec:
      volumes:
        - name: postfix-config
          configMap:
            name: postfix-conf
        - name: opendkim-config
          configMap:
            name: opendkim-conf
        - name: opendkim-certs
          secret:
            secretName: opendkim-certs
        - name: resolv-conf
          hostPath:
            path: /etc/resolv.conf
            type: File
        - name: postfix-queue                # NEW: queue directory
          emptyDir: {}
      securityContext:
        runAsUser: 0                         # run as root so postfix can init
        runAsGroup: 0
        fsGroup: 101                         # postfix group ID
      initContainers:
        - name: copy-postfix-config
          image: busybox:latest
          command: ["/bin/sh", "-c"]
          args:
            - |
              cp -f /config/main.cf /etc/postfix/
          volumeMounts:
            - name: postfix-config
              mountPath: /config
            - name: postfix-data
              mountPath: /etc/postfix
        - name: init-postfix-queue           # NEW: initialize /var/spool/postfix
          image: "ghcr.io/schub-cloud/docker-images:gophish-postfix-4d9b39"
          command: ["/bin/sh", "-c"]
          args:
            - |
              mkdir -p /var/spool/postfix && \
              postfix set-permissions && \
              postfix check
          volumeMounts:
            - name: postfix-queue
              mountPath: /var/spool/postfix
      containers:
        - name: postfix
          image: "ghcr.io/schub-cloud/docker-images:gophish-postfix-4d9b39"
          resources: 
            limits:
              cpu: {{ .Values.postfix.resources.limits.cpu }}
              memory: {{ .Values.postfix.resources.limits.memory }}
            requests:
              cpu: {{ .Values.postfix.resources.requests.cpu }}
              memory: {{ .Values.postfix.resources.requests.memory }}
          securityContext:
            capabilities:
              add: ["SYS_CHROOT"]
          volumeMounts:
            - name: postfix-config
              mountPath: /etc/aliases
              subPath: aliases
            - name: postfix-config
              mountPath: /etc/mailname
              subPath: mailname
            - name: postfix-data
              mountPath: /etc/postfix
            - name: opendkim-config
              mountPath: /etc/opendkim.conf
              subPath: opendkim.conf
            - name: opendkim-config
              mountPath: /etc/opendkim/SigningTable
              subPath: SigningTable
            - name: opendkim-config
              mountPath: /etc/opendkim/KeyTable
              subPath: KeyTable
            - name: opendkim-config
              mountPath: /etc/opendkim/TrustedHosts
              subPath: TrustedHosts
            - name: opendkim-certs
              mountPath: /etc/opendkim/keys/schub.cloud
              subPath: default.private
            - name: resolv-conf
              mountPath: /var/spool/postfix/etc/resolv.conf
            - name: postfix-queue             # NEW: mount queue
              mountPath: /var/spool/postfix
    volumeClaimTemplates:
    - metadata:
        name: postfix-data
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: "100Mi"
            - name: postfix-queue             # NEW: mount queue
              mountPath: /var/spool/postfix
{{- end }}
